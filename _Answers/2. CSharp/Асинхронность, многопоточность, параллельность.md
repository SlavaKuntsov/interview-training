## Асинхронность (Asynchronous Programming)

Асинхронность в .NET реализуется через модель **Task-based Asynchronous Pattern (TAP)** и ключевые слова `async`/`await`.

- **Task и Task** — представляют незавершённую работу. Метод, возвращающий `Task`, начинает выполнение, освобождая вызывающий поток.
    
- **async/await**:
    
    - Маркировка метода как `async` позволяет использовать `await` внутри.
        
    - `await` приостанавливает выполнение метода до завершения задачи, не блокируя поток, и возвращает управление контексту (UI или потоку пула).
        
    - После завершения задачи метод продолжит исполнение с точки `await`.
        
- **SynchronizationContext и TaskScheduler**:
    
    - В UI‑приложениях (`WinForms`, `WPF`, `ASP.NET Core` без синхронного контекста) `await` будет по умолчанию возвращать в исходный контекст.
        
    - `ConfigureAwait(false)` отключает возвращение в исходный контекст, что полезно в библиотеках и серверном коде.
        
- **CancellationToken**:
    
    - Позволяет отменять асинхронные операции.
        
    - Передаётся в методы и задачи, проверяется в процессе выполнения.
        
- **Паттерны**:
    
    - **Async all the way**: методы, которые вызывают асинхронные операции, сами должны быть асинхронными.
        
    - **Fire-and-forget**: при намерении не ждать завершения, но при этом обрабатывать исключения.
        

## Многопоточность (Multithreading)

Многопоточность — одновременное существование нескольких потоков выполнения в одном процессе.

- **System.Threading.Thread** — явное создание и управление потоком:
    
    ```csharp
    var thread = new Thread(() => DoWork());
    thread.Start();
    thread.Join();
    ```
    
- **ThreadPool**:
    
    - Управляемый пул рабочих потоков для выполнения коротких задач.
        
    - Автоматически масштабируется по нагрузке.
        
    - Использование через `Task.Run` или `ThreadPool.QueueUserWorkItem`.
        
- **Synchronization Primitives**:
    
    - **lock (Monitor)** — обеспечивает эксклюзивный доступ:
        
        ```csharp
        private readonly object _sync = new object();
        lock (_sync)
        {
            // критическая секция
        }
        ```
        
    - **SemaphoreSlim** — ограничивает число одновременных потоков.
        
    - **Mutex, ReaderWriterLockSlim, AutoResetEvent, ManualResetEvent** — для более сложной синхронизации.
        
- **Memory Barriers и volatile**:
    
    - `volatile` гарантирует, что чтение/запись поля происходит напрямую в память, без кэширования.
        
    - `Thread.MemoryBarrier()` устанавливает барьеры упорядочения.
        
- **Проблемы**:
    
    - Гонки данных (data races)
        
    - Deadlock (взаимная блокировка)
        
    - Livelock, Starvation
        

## Параллельность (Parallelism)

Параллельность — выполнение нескольких вычислительных задач одновременно на разных ядрах процессора.

- **Task Parallel Library (TPL)**:
    
    - `Parallel.Invoke`, `Parallel.For`, `Parallel.ForEach` — для параллельного выполнения циклов и делегатов.
        
    - Управляет распределением работы по ядрам.
        
- **PLINQ (Parallel LINQ)**:
    
    - Расширение LINQ: `myCollection.AsParallel().Where(...).Select(...).ToList()`.
        
    - Использует TPL под капотом, автоматически разделяет работу.
        
- **Partitioning**:
    
    - **StaticPartitioner**: равномерное деление итераций.
        
    - **DynamicPartitioner**: делится по требованиям, уменьшает время ожидания.
        
- **Cancellation и Exceptions**:
    
    - Передача `ParallelOptions` с `CancellationToken` и максимальным числом параллелизма.
        
    - Сбор исключений в `AggregateException`.
        
- **Affinity и масштабируемость**:
    
    - Устанавливайте `MaxDegreeOfParallelism` для контроля числа одновременных задач.
        
    - Оценивайте overhead от распараллеливания малого объёма работы.
        

## Сравнение и выбор паттерна

|Параметр|Асинхронность|Многопоточность|Параллельность|
|---|---|---|---|
|Цель|Неблокирующий ввод/вывод (I/O)|Изоляция работы в потоки|Распараллеливание CPU-bound|
|Инструменты .NET|async/await, Task|Thread, ThreadPool, lock|Parallel, PLINQ, TPL|
|Overhead|Низкий (контексты, state machine)|Средний (создание потоков)|Средний/высок (распределение)|
|Сложность ошибок|Синхронные баги, continuation bugs|Deadlock, race conditions|Deadlock, contention, overhead|

**Рекомендации:**

- Для операций ввода/вывода всегда предпочтителен async/await.
    
- Для независимых вычислений большого объёма — распараллеливание (TPL, PLINQ).
    
- Для тонкого контроля над потоками — ThreadPool и явные потоки.
    
- Всегда обрабатывайте отмену и исключения.
    

---

_Основано на опыте разработки .NET, официальной документации Microsoft и практике проведения технических интервью._