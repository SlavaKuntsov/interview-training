![[Pasted image 20241113065847.png]]
### Определение транзакции
Транзакция — это последовательность операций над данными, которые выполняются как единое логическое действие. Основные свойства транзакции обеспечивают корректность, целостность и надёжность данных даже при сбоях и конкурирующем доступе.

---

### Ключевые свойства транзакции (ACID)

1. **Атомарность (Atomicity)**  
   Все операции внутри транзакции выполняются либо полностью, либо не выполняются вовсе. При сбое транзакция полностью откатывается к исходному состоянию.

2. **Согласованность (Consistency)**  
   Каждая транзакция переводит систему из одного валидного состояния в другое, соблюдая все ограничения (схемные, бизнес-правила, внешние ключи, уникальности и т. д.).

3. **Изолированность (Isolation)**  
   Одновременное выполнение транзакций не приводит к нарушению целостности: изоляция определяет, какие промежуточные изменения “видны” параллельным транзакциям (уровни — READ UNCOMMITTED, READ COMMITTED, REPEATABLE READ, SERIALIZABLE, SNAPSHOT).

4. **Надёжность (Durability)**  
   После успешного коммита все изменения транзакции гарантированно сохраняются на диске и переживут сбой системы.

---

### Механизмы реализации

#### Write‑Ahead Logging (WAL)
- **Описание:** перед изменением основной БД все “redo” и “undo” записи сначала пишутся в журнал (лог).  
- **Восстановление:** при старте после сбоя СУБД анализирует лог, повторяет комитнутые операции (redo) и откатывает незакомиченные (undo).

#### Блокировки (Locks)
- **Shared/Exclusive Locks:**  
  - Shared (S‑lock) для чтения — несколько транзакций могут читать одну строку.  
  - Exclusive (X‑lock) для записи — только одна транзакция может изменять строку.  
- **Гранулярность:** строки, страницы, таблицы — влияет на степень параллелизма и риск блокировок.

#### Многоверсионная конкуренция (MVCC)
- **Снимки данных:** каждая транзакция видит свою версию данных, “фотографию” на момент старта (или последнего коммита).  
- **Избавление от блокировок на чтении:** читатели не мешают писателям и наоборот, но сложнее выполнять GC старых версий и контролировать рост хранилища.

---

### Уровни изоляции и аномалии

| Уровень           | Dirty Read | Non‑repeatable Read | Phantom Read |
|-------------------|------------|---------------------|--------------|
| READ UNCOMMITTED  | да         | да                  | да           |
| READ COMMITTED    | нет        | да                  | да           |
| REPEATABLE READ   | нет        | нет                 | да           |
| SERIALIZABLE      | нет        | нет                 | нет          |
| SNAPSHOT (MVCC)   | нет        | нет                 | нет          |

- **Dirty Read:** чтение незакомиченных данных.  
- **Non‑repeatable Read:** при повторном чтении одна и та же строка имеет разные значения.  
- **Phantom Read:** повторный запрос возвращает добавленные или удалённые строки.

---

### Пессимистические vs оптимистические транзакции

- **Пессимистические**  
  - Сразу ставят блокировки на чтение и/или запись.  
  - Подходят для высоко конфликтных сценариев, но снижают параллелизм.

- **Оптимистические**  
  - Сначала читают данные без блокировок, проверяют версию/таймстамп при коммите.  
  - При конфликте откатывают и могут повторить транзакцию.  
  - Хороши при низкой конкуренции за одни и те же строки.

---

### Двухфазный коммит (2PC) и распределённые транзакции

1. **Фаза подготовки (Prepare)**  
   Координатор запрашивает у всех участников–ресурсов (БД, брокеров очередь) готовность закоммитить. Участники резервируют ресурсы и отвечают “готово” или “нет”.

2. **Фаза коммита (Commit / Rollback)**  
   - Если все участники “готовы”, координатор рассылает команду COMMIT.  
   - Если хоть один отказался, рассылается ROLLBACK.  
   После этого каждый участник выполняет команду и подтверждает.

**Недостатки 2PC:**  
- Блокировка ресурсов до завершения: снижает производительность.  
- Слабая устойчивость к сбоям координатора (координатор-зависимость).

---

### Альтернативы распределённых транзакций

- **Three‑Phase Commit (3PC):** добавляет промежуточную фазу “предварительного коммита” для уменьшения блокировок, но усложняет логику.
- **Саги (Sagas):**  
  - Разбивают долгие бизнес‑процессы на цепочку локальных транзакций.  
  - При сбое одна за другой выполняются компенсирующие транзакции «отката» предыдущих шагов.  
  - Поддержка на уровне оркестрации (Saga‑pattern) или хореографии (событийный обмен).

---

### Практические рекомендации

- **Держите транзакции короткими** — минимизируйте время удержания блокировок и объём данных.  
- **Выбирайте оптимальный уровень изоляции** — балансируйте между консистентностью и параллелизмом.  
- **Используйте MVCC** — если ваша СУБД поддерживает, для снижения конфликтов чтения.  
- **Мониторьте блокировки и ожидания** — инструменты типа `pg_locks` (PostgreSQL), `sys.dm_tran_locks` (SQL Server).  
- **Для распределённых систем**: предпочитайте саги при длинных процессах, чтобы избежать проблем 2PC.  
- **Логируйте и трассируйте** — при сбоях и дедлоках быстрый анализ логов транзакций и блокировок существенно экономит время.

---

Понимание общей теории транзакций, механизмов их обеспечения и компромиссов между производительностью и консистентностью позволяет проектировать надёжные распределённые и локальные системы хранения данных.
 