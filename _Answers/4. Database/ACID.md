### Atomicity (Атомарность)
- **Суть**: все операции в рамках транзакции рассматриваются как единое неделимое действие.  
- **Поведение**: либо все изменения, внесённые транзакцией, полностью применяются, либо не применяется ни одно.  
- **Механизм реализации**:  
  - **Логи транзакций (Write-Ahead Logging, WAL)** — прежде чем внести изменение в основную БД, СУБД записывает «доку» (redo/undo-записи) в журнал.  
  - При сбое или откате транзакции выполняется откат до предшествующего состояния с помощью undo-записей.  
- **Пример**: перевод денег между счетами:
  1. Списать 100 ₽ со счёта A  
  2. Зачислить 100 ₽ на счёт B  
  Если списание прошло, а зачисление упало, вся транзакция откатывается, и остатки счётов не меняются.

---

### Consistency (Согласованность)
- **Суть**: транзакция переводит базу данных из одного **корректного** состояния в другое, соблюдая все заданные ограничения.  
- **Виды ограничений**:  
  - **Схемные**: типы данных, длина строк, обязательные поля (`NOT NULL`), внешние ключи (`FOREIGN KEY`), уникальность (`UNIQUE`), проверки (`CHECK`).  
  - **Пользовательские**: триггеры и бизнес-логика, реализованная на уровне СУБД (или приложений).  
- **Поведение**: нарушение любого ограничения внутри транзакции приводит к её откату.  
- **Пример**: если в таблице `Orders` внешний ключ `CustomerId` не совпадает ни с одним `Id` из `Customers`, вставка или обновление транзакции будет отменено.

---

### Isolation (Изолированность)
- **Суть**: параллельно выполняющиеся транзакции **не должны** мешать друг другу, каждую транзакцию система «видит» так, как если бы она шла по отдельной копии данных.  
- **Аномалии изоляции**:
  1. **Dirty Read** — чтение незакомиченных данных другой транзакции.  
  2. **Non‑repeatable Read** — при повторном чтении одних и тех же строк вы видите разные данные (из-за комита другой транзакции).  
  3. **Phantom Read** — при повторном выполнении одного и того же запроса вы получаете другой набор строк (новые или удалённые записи).  
- **Уровни изоляции (ANSI SQL)**:

  | Уровень              | Dirty Read | Non‑repeatable Read | Phantom Read |
  |----------------------|------------|---------------------|--------------|
  | READ UNCOMMITTED     | разрешены  | разрешены           | разрешены    |
  | READ COMMITTED       | запрещены  | разрешены           | разрешены    |
  | REPEATABLE READ      | запрещены  | запрещены           | разрешены    |
  | SERIALIZABLE         | запрещены  | запрещены           | запрещены    |

- **Реализации**:
  - **Блокировки (Locks)** — Shared/Exclusive блокировки на уровне строк, страниц, таблиц.  
  - **Многоверсионность (MVCC)** — каждая транзакция видит свою «снимок» данных; новые записи не мешают старым (Oracle, PostgreSQL, SQL Server Snapshot Isolation).  
- **Пример аномалии phantom-read**:  
  1. Т1: `SELECT COUNT(*) FROM Products WHERE Price > 100;` → 5  
  2. Т2: `INSERT INTO Products (Name, Price) VALUES ('X', 150);` и коммит  
  3. Т1 повторяет `SELECT COUNT(*) ...;` → 6  

---

### Durability (Надёжность/Жёсткость)
- **Суть**: после успешного коммита транзакции все её изменения **гарантированно** сохраняются в постоянном хранилище, даже в случае сбоя системы (падения сервера, отключения питания).  
- **Механизм реализации**:
  - **Журнализация (WAL)**: перед комитом изменения записываются в устойчивый лог, который периодически сбрасывается на диск (`fsync`).  
  - **Чекпоинты**: периодическая синхронизация данных и лога, что ускоряет восстановление (recovery).  
- **Восстановление после сбоя**:
  1. **Analysis Phase**: СУБД сканирует лог, определяя транзакции, которые были завершены или в процессе.  
  2. **Redo Phase**: Применяет все «redo»-записи комитнутых транзакций.  
  3. **Undo Phase**: Откатывает незакомиченные транзакции по «undo»-записям.  
- **Пример**: если система упала сразу после ответа «Коммит успешен», при рестарте все изменения сохранятся из-за предварительной записи в журнал.

---

### ACID vs BASE
| Характеристика    | ACID                                | BASE                                   |
|-------------------|-------------------------------------|----------------------------------------|
| Подход            | Строгие транзакции                  | Лёгкая согласованность, eventual-consistency |
| Надежность данных | Гарантируется сразу после коммита   | Гарантируется «рано или поздно»       |
| Изоляция          | Жёсткая (SERIALIZABLE и ниже уровни)| Минимальная (одна запись за раз)      |
| Применение        | Традиционные реляционные СУБД       | Распределённые NoSQL-системы          |

---

### Практические советы
- **Выбирайте нужный уровень изоляции**:  
  - `READ COMMITTED` или `SNAPSHOT` по умолчанию в большинстве СУБД для баланса между производительностью и корректностью.  
  - `SERIALIZABLE` только в критичных сценариях, чтобы избежать phantom‑anomalies.  
- **Используйте короткие транзакции**: минимизируйте время удержания блокировок.  
- **Мониторьте логи блокировок и ожиданий**: `sys.dm_tran_locks` (SQL Server), `pg_locks` (PostgreSQL).  
- **Настраивайте чекпоинты**: реже — ускоренная запись, чаще — быстрый recovery.  
- **Для систем с высокой нагрузкой**: рассмотрите MVCC-ориентированные СУБД с snapshot‑изоляцией.

---

Понимание ACID-контрактов и внутренней работы транзакций позволяет проектировать надёжные и производительные приложения, избегать состояний гонок и потерянных обновлений, а также грамотно выбирать настройки СУБД под ваши бизнес-задачи.
